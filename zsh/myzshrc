#!/usr/bin/zsh

#
# helper
#
SCRIPT_DIR=$(cd "$(dirname "${0:-$BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
source $SCRIPT_DIR/modules/helper/init.sh

#
# prompt
#
local cyan=$'\e[36m' reset=$'\e[m'
PROMPT="%{${cyan}%}%m:%1d%# %{${reset}%}"

#
# Load environment variables
#
if [ -f "$HOME/.env" ]; then
  set -a  # Treat all subsequent variable definitions as exports
  . "$HOME/.env"
  set +a
fi

#
# shortcut
#
# Delete all existing keymaps and reset to the default state.
bindkey -d
# Selects keymap `emacs'.
bindkey -e

#
# compinit
#
autoload -Uz compinit && compinit

#
# Welcome Message
#
my_log `uname -a`

# Beep off on error in ZLE
setopt no_beep

# Editor
if type "vim" > /dev/null 2>&1; then
  export EDITOR="vim"
fi

#
# the number of commands that are stored in the zsh history file
#
export SAVEHIST=5000000

#
# Share command history across all zsh sessions in real time.
# Useful when working with multiple terminal windows or tabs.
# Ensures history is immediately written to and read from the history file.
#
setopt share_history

#
# Ignore history duplicates
# Do not enter command lines into the history list if they are duplicates of the
# previous event.
#
setopt hist_ignore_dups

#
# When searching for history entries in the line editor, do not display duplicates
# of a line previously found, even if the duplicates are not contiguous.
#
setopt hist_find_no_dups

# Inform gpg-agent of the current TTY for user prompts.
# If you want to check gpg, type:
#   echo 'test' | gpg --clearsign
#
# BUT, Unable to List GPG Keys in Dev Container or Sign Git Commits
# https://github.com/microsoft/vscode-remote-release/issues/8549
export GPG_TTY=$TTY

#
# zsh-autosuggestions
#
# If you press `Ctrl + e` or the `â†’` key (forward-char widget) or End (end-of-line widget) with the cursor at the end of the buffer,
# it will accept the suggestion, replacing the contents of the command line buffer with the suggestion.
#
if [ -f "$SCRIPT_DIR/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
  source $SCRIPT_DIR/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

#
# Mac
#
if is-darwin; then
  #
  # brew
  #
  if [ -e /opt/homebrew/bin/brew ]; then
    eval $(/opt/homebrew/bin/brew shellenv)
  fi

  #
  # zsh-completions
  #
  # You may also need to force rebuild `zcompdump`:
  #
  #   rm -f ~/.zcompdump; compinit
  #
  # Additionally, if you receive "zsh compinit: insecure directories" warnings when attempting
  # to load these completions, you may need to run these commands:
  #
  #   chmod go-w '/opt/homebrew/share'
  #   chmod -R go-w '/opt/homebrew/share/zsh'
  #
  if type brew &>/dev/null; then
    FPATH=$(brew --prefix)/share/zsh-completions:$FPATH

    autoload -Uz compinit
    compinit
  fi

  #
  # Visual Studio Code
  #
  # To run VS Code from the terminal by typing `code`, add it the $PATH environment variable:
  #
  code_path=/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin
  if [ -d $etc ]; then
    export PATH=$code_path:${PATH}
  fi

  #
  # Docker
  #
  etc=/Applications/Docker.app/Contents/Resources/etc
  target=~/dotfiles/zsh/completion
  if [ -d $etc ]; then
    ln -fs $etc/docker.zsh-completion $target/_docker
    ln -fs $etc/docker-compose.zsh-completion $target/_docker-compose
    fpath=($target $fpath)
    zstyle ':completion:*:*:docker:*' option-stacking yes
    zstyle ':completion:*:*:docker-*:*' option-stacking yes
    autoload -Uz compinit && compinit -i
  fi

  #
  # SSH
  #
  if [ ! -d ~/.ssh ]; then
    # Prepare the directory in advance to prevent it from being owned by root when mounting keys
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
  fi


  #
  # Docker CLI Plugins
  #
  plugins=$HOME/.docker/cli-plugins
  if [ -d $plugins ]; then
    export PATH=$plugins:${PATH}
  fi

  #
  # PostgreSQL(psql)
  #
  if type brew &>/dev/null; then
    libpq=$(brew --prefix)/opt/libpq/bin
    if [ -d $libpq ]; then
      export PATH=$libpq:${PATH}
    fi
  fi

  #
  # Alias
  #
  alias bell='afplay /System/Library/Sounds/Frog.aiff'
fi

#
# fzf module
#
# NOTE: This must come after Homebrew initialization on Mac.
# fzf is installed via Homebrew, so /opt/homebrew/bin must be in PATH
# before `type fzf` can find it.
#
if type fzf > /dev/null 2>&1; then
  source $SCRIPT_DIR/modules/fzf-init.sh
fi

#
# Docker
#
if is-docker; then
  # This setting preserves the history even after restarting the Docker container.
  # https://github.com/uraitakahito/claude-code-docker/blob/0224b6a1c03bc3f47ebff7bcd23ab23da8a9f23c/Dockerfile#L32-L51
  if [ -d /zsh-volume ]; then
    export HISTFILE=/zsh-volume/.zsh_history
  fi
fi

#
# rbenv
#
[[ -d $HOME/.rbenv ]] && \
  export PATH=${HOME}/.rbenv/bin:${PATH} && \
  eval "$(rbenv init - zsh)"

#
# nodenv
#
[[ -d $HOME/.nodenv ]] && \
  eval "$(nodenv init - zsh)"
# https://github.com/uraitakahito/features/blob/8291744831e2c42b6c01fe169e98cca2a4b7fbc9/src/node/install.sh#L13
if { [ -d $HOME/.nodenv ] } || { [ -d /usr/local/share/nvm ] }; then
  export PATH=$PATH:./node_modules/.bin
fi

#
# uv
# https://zenn.dev/tadayosi/articles/522efbda48fbf4
#
if type uv &>/dev/null; then
  eval "$(uv generate-shell-completion zsh)"

  _uv_run_mod() {
      if [[ "$words[2]" == "run" && "$words[CURRENT]" != -* ]]; then
          _arguments '*:filename:_files'
      else
          _uv "$@"
      fi
  }
  compdef _uv_run_mod uv
fi

#
# Go
# https://github.com/devcontainers/features/tree/main/src/go
#
[[ -d /usr/local/go/bin ]] && \
  export PATH=/usr/local/go/bin:${PATH}
[[ -d /go/bin ]] && \
  export PATH=/go/bin:${PATH}
# https://go.dev/wiki/GOPATH
export PATH=$HOME/go/bin:${PATH}

#
# zoxide
# https://github.com/ajeetdsouza/zoxide
#
if type zoxide > /dev/null 2>&1; then
  export _ZO_DATA_DIR=${XDG_DATA_HOME-$HOME/.zoxide/data}
  eval "$(zoxide init zsh)"
fi

#
# Aliases
#

#
# Type:
# brew install --cask font-meslo-lg-nerd-font
#
alias a='eza --icons'
alias ll='eza -l -g --icons'
#
# Enable file/directory name completion for 'a' and 'll' aliases.
#
# Why use '_files' instead of '_eza':
#   The '_eza' completion function uses '_arguments' internally, which expects
#   to parse options from the beginning of the command line. However, since
#   these aliases already include options (e.g., '--icons', '-l', '-g'),
#   '_arguments' gets confused about the argument position, causing file name
#   completion to fail.
#
#   Using '_files' directly provides simple file/directory completion without
#   attempting to parse eza's options. This is sufficient for these aliases
#   since they are primarily used for listing files.
#
# Trade-off:
#   - Works: Tab completion for file and directory names
#   - Not available: eza option completion (e.g., --long, --all)
#
compdef _files a ll

alias d='docker'
if ! is-darwin; then
  # https://github.com/sharkdp/bat/issues/982
  alias bat='batcat --style=plain'
else
  alias bat='bat --style=plain'
fi

#
# Git aliases
#
alias c='git commit -v'
alias g='git'
alias s='git status'

# trash-cli
# https://github.com/andreafrancia/trash-cli
if type trash-put > /dev/null 2>&1; then
  alias rm='trash-put'
fi
