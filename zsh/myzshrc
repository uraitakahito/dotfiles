#!/usr/bin/zsh
# prompt
#
local cyan=$'\e[36m' reset=$'\e[m'
PROMPT="%{${cyan}%}%1d%# %{${reset}%}"

#
# shortcut
#
# Delete all existing keymaps and reset to the default state.
bindkey -d
# Selects keymap `emacs'.
bindkey -e

#
# compinit
#
autoload -Uz compinit && compinit

#
# helper
#
SCRIPT_DIR=$(cd "$(dirname "${0:-$BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
source $SCRIPT_DIR/modules/helper/init.sh

#
# Welcome Message
#
my_log `uname -a`

# Beep off on error in ZLE
setopt no_beep

# Editor
if type "vim" > /dev/null 2>&1; then
  export EDITOR="vim"
fi

#
# the number of commands that are stored in the zsh history file
#
export SAVEHIST=100000

#
# Ignore history duplicates
# Do not enter command lines into the history list if they are duplicates of the
# previous event.
#
setopt hist_ignore_dups

#
# When searching for history entries in the line editor, do not display duplicates
# of a line previously found, even if the duplicates are not contiguous.
#
setopt hist_find_no_dups

# Inform gpg-agent of the current TTY for user prompts.
# If you want to check gpg, type:
#   echo 'test' | gpg --clearsign
#
# BUT, Unable to List GPG Keys in Dev Container or Sign Git Commits
# https://github.com/microsoft/vscode-remote-release/issues/8549
export GPG_TTY=$TTY

# reverse-i-search with fzf
function select-history() {
  BUFFER=$(history -n -r 1 | fzf --no-sort +m --query "$LBUFFER" --prompt="History > ")
  CURSOR=$#BUFFER
}
zle -N select-history
bindkey '^r' select-history

# fgitshow - git commit browser
fgitshow() {
  git log --graph --color=always \
      --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
  fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
      --bind "ctrl-m:execute:
                (grep -o '[a-f0-9]\{7\}' | head -1 |
                xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
                {}
FZF-EOF"
}

# fcd - cd to selected directory
fcd() {
  local dir
  dir=$(find ${1:-.} -path '*/\.*' -prune \
                  -o -type d -print 2> /dev/null | fzf +m) &&
  cd "$dir"
}

#
# fdshell - Login to Docker with shell
#   usage: fdshell /bin/bash
#
fdshell() {
  local cid
  cid=$(docker ps | sed 1d | fzf | awk '{print $1}')
  [ -n "$cid" ] && docker exec -it "$cid" $1
}

#
# fdstop - Stop a running container
#   usage: fdstop
#
fdstop() {
  local cid
  cid=$(docker ps | sed 1d | fzf | awk '{print $1}')
  [ -n "$cid" ] && docker stop "$cid"
}

#
# fdvscode - Attach to a running container with VS Code
#   usage: fdvscode
#   https://github.com/microsoft/vscode-remote-release/issues/5278#issuecomment-1625401636
fdvscode() {
  local cid
  cid=$(docker ps | sed 1d | fzf | awk '{print $NF}')
  [ -n "$cid" ] && code --folder-uri vscode-remote://attached-container+$(printf "$cid" | od -A n -t x1 | sed 's/ *//g' | tr -d '\n')/app
}

#
# Mac
#
if is-darwin; then
  #
  # brew
  #
  if [ -e /opt/homebrew/bin/brew ]; then
    eval $(/opt/homebrew/bin/brew shellenv)
  fi

  #
  # Docker
  #
  etc=/Applications/Docker.app/Contents/Resources/etc
  target=~/dotfiles/zsh/completion
  if [ -d $etc ]; then
    ln -fs $etc/docker.zsh-completion $target/_docker
    ln -fs $etc/docker-compose.zsh-completion $target/_docker-compose
    fpath=($target $fpath)
    zstyle ':completion:*:*:docker:*' option-stacking yes
    zstyle ':completion:*:*:docker-*:*' option-stacking yes
    autoload -Uz compinit && compinit -i
  fi

  #
  # Docker CLI Plugins
  #
  plugins=$HOME/.docker/cli-plugins
  if [ -d $plugins ]; then
    export PATH=$plugins:${PATH}
  fi

  #
  # Alias
  #
  alias bell='afplay /System/Library/Sounds/Frog.aiff'
fi

#
# rbenv
#
[[ -d $HOME/.rbenv ]] && \
  export PATH=${HOME}/.rbenv/bin:${PATH} && \
  eval "$(rbenv init - zsh)"

#
# nodenv
#
[[ -d $HOME/.nodenv ]] && \
  eval "$(nodenv init - zsh)"
# https://github.com/uraitakahito/features/blob/8291744831e2c42b6c01fe169e98cca2a4b7fbc9/src/node/install.sh#L13
if { [ -d $HOME/.nodenv ] } || { [ -d /usr/local/share/nvm ] }; then
  export PATH=$PATH:./node_modules/.bin
fi

#
# Go
# https://github.com/devcontainers/features/tree/main/src/go
#
[[ -d /usr/local/go/bin ]] && \
  export PATH=/usr/local/go/bin:${PATH}
[[ -d /go/bin ]] && \
  export PATH=/go/bin:${PATH}
# https://go.dev/wiki/GOPATH
export PATH=$HOME/go/bin:${PATH}

#
# Aliases
#
alias a='eza --icons'
alias ll='eza -l -g --icons'
alias d='docker'
if ! is-darwin; then
  # https://github.com/sharkdp/bat/issues/982
  alias bat='batcat --style=plain'
fi

#
# Git aliases
#
alias c='git commit -v'
alias g='git'
alias s='git status'

# trash-cli
# https://github.com/andreafrancia/trash-cli
if type trash-put > /dev/null 2>&1; then
  alias rm='trash-put'
fi
